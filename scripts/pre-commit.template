#!/bin/bash
#
# Mizan Platform Quality Gate - Pre-Commit Hook
# Runs complete 5-agent pipeline with interactive human review
# Automatically fixes violations before allowing commit
#
# Installation: Copy to .git/hooks/pre-commit
# cp scripts/pre-commit.template .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit
#
# To bypass (NOT RECOMMENDED): git commit --no-verify
#

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸš€ Mizan Quality Pipeline - Pre-Commit Automation"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Change to repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# Check if Node.js is available
if ! command -v node &> /dev/null; then
  echo "âš ï¸  Node.js not found - skipping quality pipeline"
  echo "   Install Node.js to enable automated quality assurance"
  echo ""
  exit 0
fi

# Check if pipeline exists
if [ ! -f "scripts/mizan-pipeline.js" ]; then
  echo "âš ï¸  Mizan pipeline not found - skipping quality checks"
  echo "   This is expected for initial setup commits"
  echo ""
  exit 0
fi

# Always run full project audit - no file type restrictions
echo "ğŸ“Š Running complete project audit (all files)"
echo ""
echo "ğŸ”„ Running Complete Quality Pipeline:"
echo "   1ï¸âƒ£  Code Audit - Scan for violations"
echo "   2ï¸âƒ£  5-Agent Analysis - Generate fixes"
echo "   3ï¸âƒ£  Interactive Review - Your approval"
echo "   4ï¸âƒ£  Auto-Apply Fixes - Clean code"
echo ""
echo "â³ This may take a few minutes..."
echo ""

# Run the complete quality pipeline
INTERACTIVE=true node scripts/mizan-pipeline.js

PIPELINE_EXIT_CODE=$?

if [ $PIPELINE_EXIT_CODE -eq 0 ]; then
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âœ… Quality pipeline PASSED - Commit approved!"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "All quality checks passed. Your code is ready for commit."
  echo ""
  exit 0
else
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo "âŒ COMMIT BLOCKED - Quality pipeline failed or was cancelled"
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  echo "Possible reasons:"
  echo "   â€¢ You cancelled the interactive review"
  echo "   â€¢ Pipeline encountered errors"
  echo "   â€¢ Critical violations remain unfixed"
  echo ""
  echo "ğŸ“‹ Next steps:"
  echo "   1. Review the output above for details"
  echo "   2. Fix any critical issues manually"
  echo "   3. Run: node scripts/mizan-pipeline.js (to retry)"
  echo "   4. Try committing again"
  echo ""
  echo "âš ï¸  To bypass this check (NOT RECOMMENDED for production):"
  echo "   git commit --no-verify"
  echo ""
  echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
  echo ""
  exit 1
fi

