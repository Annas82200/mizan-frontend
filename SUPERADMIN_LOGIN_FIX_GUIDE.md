# Superadmin Login & CORS Fix - Deployment Guide

## üö® Critical: Environment Variables Must Be Set

The superadmin login CORS errors are caused by missing or incorrect environment variables in your deployment platforms. Follow this guide **exactly** to fix the issues.

---

## üìã Pre-Deployment Checklist

Before deploying, ensure you have:
- [ ] Access to Vercel dashboard (https://vercel.com/dashboard)
- [ ] Access to Railway dashboard (https://railway.app/dashboard)
- [ ] Superadmin credentials (anna@mizan.com)
- [ ] Database access (if needed to verify superadmin user exists)

---

## üîß Step 1: Configure Vercel Environment Variables

### Access Vercel Dashboard

1. Go to https://vercel.com/dashboard
2. Select your project: **mizan-platform-final** or **mizan.work**
3. Click **Settings** ‚Üí **Environment Variables**

### Add Required Variables

Click **Add** and enter:

| Variable Name | Value | Environment |
|---------------|-------|-------------|
| `NEXT_PUBLIC_API_URL` | `https://mizan-backend-production.up.railway.app` | Production, Preview, Development |

**Important Notes:**
- The variable name MUST start with `NEXT_PUBLIC_` to be accessible in the browser
- Do NOT add trailing slashes to the URL
- Apply to all environments (Production, Preview, Development)

### Redeploy Frontend

After adding the variable:
1. Go to **Deployments** tab
2. Click on the latest deployment
3. Click **Redeploy** button
4. Wait 2-3 minutes for deployment to complete

---

## üîß Step 2: Verify Railway Environment Variables

### Access Railway Dashboard

1. Go to https://railway.app/dashboard
2. Select your project: **mizan-backend-production**
3. Click **Variables** tab

### Verify Required Variables

Ensure these variables are set:

| Variable Name | Value | Notes |
|---------------|-------|-------|
| `DATABASE_URL` | `postgresql://...` | Auto-generated by Railway |
| `CLIENT_URL` | `https://www.mizan.work` | Your production frontend URL |
| `FRONTEND_URL` | `https://www.mizan.work` | Alternative frontend URL |
| `JWT_SECRET` | `<64-char-hex-string>` | Generate if not set |
| `SESSION_SECRET` | `<64-char-hex-string>` | Generate if not set |
| `NODE_ENV` | `production` | Environment mode |
| `PORT` | `3001` | Server port (usually auto-set) |

### Generate Secrets (If Needed)

If `JWT_SECRET` or `SESSION_SECRET` are not set, generate them:

```bash
# Run this locally to generate strong secrets
node -e "console.log('JWT_SECRET=' + require('crypto').randomBytes(64).toString('hex'))"
node -e "console.log('SESSION_SECRET=' + require('crypto').randomBytes(64).toString('hex'))"
```

Copy the output and add to Railway variables.

### Deploy Backend

If you made changes:
1. Railway will auto-deploy when you save variables
2. Wait 2-3 minutes for deployment
3. Check logs for any errors

---

## üß™ Step 3: Verify Backend is Running

### Test Health Endpoint

Open in browser or use curl:

```bash
curl https://mizan-backend-production.up.railway.app/health
```

**Expected Response:**
```json
{
  "status": "healthy",
  "server": "running",
  "database": {
    "connected": true,
    "status": "connected"
  },
  "timestamp": "2025-01-16T...",
  "version": "2.0.0"
}
```

If this fails:
- Check Railway logs for errors
- Verify DATABASE_URL is correct
- Check if service is running

---

## üß™ Step 4: Test CORS Configuration

### Test Preflight Request

```bash
curl -i -X OPTIONS https://mizan-backend-production.up.railway.app/api/superadmin/stats \
  -H "Origin: https://www.mizan.work" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization"
```

**Expected Response Headers:**
```
Access-Control-Allow-Origin: https://www.mizan.work
Access-Control-Allow-Credentials: true
Access-Control-Allow-Methods: GET,POST,PUT,DELETE,PATCH,OPTIONS
```

If CORS headers are missing:
- Verify `CLIENT_URL` and `FRONTEND_URL` in Railway
- Check Railway logs for CORS errors
- Redeploy backend

---

## üß™ Step 5: Test Superadmin Login

### Verify Superadmin User Exists

Connect to database and check:

```sql
SELECT id, email, role, "isActive" 
FROM users 
WHERE role = 'superadmin';
```

**Expected:** At least one row with `email = 'anna@mizan.com'` and `isActive = true`

If no superadmin exists, create one:

```bash
# Use the Railway backend endpoint
curl -X POST https://mizan-backend-production.up.railway.app/api/create-superadmin-temp
```

### Test Login Flow

1. Clear browser cache and cookies
2. Open browser console (F12)
3. Go to https://www.mizan.work/login
4. Enter superadmin credentials:
   - Email: `anna@mizan.com`
   - Password: `MizanAdmin2024!`
5. Click **Login**

**Check Console Output:**
- Should see `[API Client] Base URL: https://mizan-backend-production.up.railway.app`
- Should see `[API Request] POST /api/auth/login`
- Should see `[API Response] POST /api/auth/login 200`
- Should redirect to `/dashboard/superadmin`

### If Login Fails

**Check Browser Console:**
- Look for CORS errors
- Look for Network errors
- Check if `NEXT_PUBLIC_API_URL` is defined

**Check Network Tab:**
- Click failed request
- Check Request URL (should be Railway backend)
- Check Response headers (should include CORS headers)

**Common Issues:**
- 404 errors: Backend not deployed or wrong URL
- CORS errors: Missing environment variables
- 401 errors: Invalid credentials or superadmin doesn't exist
- Network errors: `NEXT_PUBLIC_API_URL` not configured

---

## üîç Debugging Tools

### Check Environment Variables in Browser

Open browser console on https://www.mizan.work and run:

```javascript
// Check if API URL is configured
console.log('API URL:', process.env.NEXT_PUBLIC_API_URL);

// Check if env-check tool is loaded
import('/src/lib/env-check.js').then(module => {
  module.displayEnvStatus();
});

// Check authentication
console.log('Token:', localStorage.getItem('mizan_auth_token'));
console.log('User:', localStorage.getItem('mizan_user'));
```

### Check Railway Logs

1. Go to Railway dashboard
2. Select your backend project
3. Click **Logs** tab
4. Look for:
   - CORS preflight logs: `üîç [CORS Preflight]`
   - Request logs: `üì• [Request]`
   - Authentication errors
   - Database connection errors

### Clear Browser Cache

If you're still seeing old errors:

```javascript
// In browser console
localStorage.clear();
sessionStorage.clear();
// Then hard refresh: Ctrl+Shift+R (Windows) or Cmd+Shift+R (Mac)
```

---

## ‚úÖ Verification Checklist

After deployment, verify:

- [ ] Vercel `NEXT_PUBLIC_API_URL` is set correctly
- [ ] Railway `CLIENT_URL` is set to `https://www.mizan.work`
- [ ] Railway `JWT_SECRET` and `SESSION_SECRET` are configured
- [ ] Backend health endpoint returns 200 OK
- [ ] CORS preflight test passes
- [ ] Superadmin user exists in database
- [ ] Login succeeds and redirects to dashboard
- [ ] Dashboard loads without CORS errors
- [ ] Navigation between superadmin pages works
- [ ] Browser console shows no CORS errors

---

## üêõ Troubleshooting Common Issues

### Issue: "Failed to fetch RSC payload"

**Cause:** Next.js trying to prefetch pages without authentication

**Solution:**
- This is now handled by the layout authentication check
- Pages will only load after successful authentication
- If issue persists, clear browser cache

### Issue: "Fetch API cannot load due to access control checks"

**Cause:** CORS error - backend not allowing requests from frontend

**Solution:**
1. Verify `CLIENT_URL` in Railway = `https://www.mizan.work`
2. Check Railway logs for CORS preflight requests
3. Verify backend is deployed and running
4. Test CORS with curl command above

### Issue: "Network Error"

**Cause:** Cannot connect to backend

**Solution:**
1. Check if `NEXT_PUBLIC_API_URL` is set in Vercel
2. Verify URL is correct (no trailing slash)
3. Test backend health endpoint directly
4. Check Railway deployment status

### Issue: Login succeeds but dashboard shows errors

**Cause:** API URL not configured or authentication token not included

**Solution:**
1. Check browser console for `[API Client] Base URL`
2. Verify token exists: `localStorage.getItem('mizan_auth_token')`
3. Check Network tab - requests should include `Authorization` header
4. Redeploy frontend after setting environment variables

### Issue: 401 Unauthorized after login

**Cause:** JWT token invalid or expired

**Solution:**
1. Verify `JWT_SECRET` is set in Railway
2. Check if secret was changed recently (invalidates old tokens)
3. Clear localStorage and log in again
4. Verify superadmin user exists and is active

---

## üìû Support

If issues persist after following this guide:

1. **Check Railway Logs:**
   - Look for specific error messages
   - Check database connection status
   - Verify CORS preflight logs

2. **Check Vercel Logs:**
   - Go to Deployments ‚Üí View Function Logs
   - Look for build errors or runtime errors

3. **Verify Code Changes:**
   - Ensure all files were deployed correctly
   - Check git commits are pushed to main branch
   - Verify both frontend and backend are latest version

4. **Database Check:**
   - Connect to Railway PostgreSQL
   - Verify superadmin user exists
   - Check user is active and password hash is valid

---

## üéØ Success Criteria

When everything is working correctly:

1. ‚úÖ Login page loads without errors
2. ‚úÖ Superadmin can log in successfully
3. ‚úÖ Dashboard redirects to `/dashboard/superadmin`
4. ‚úÖ All dashboard cards show data (not loading forever)
5. ‚úÖ Navigation between pages works smoothly
6. ‚úÖ Browser console shows no CORS errors
7. ‚úÖ Network tab shows all requests return 200 OK
8. ‚úÖ All API requests include Authorization header

---

**Last Updated:** January 2025
**Compliant with:** AGENT_CONTEXT_ULTIMATE.md
**Status:** Production-Ready Fix

